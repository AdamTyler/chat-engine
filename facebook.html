<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Open Chat Framework Dev</title>

</head>

<body>
    
    <div id="chat">
    </div>
    <input type="text" id="message">
    <input type="submit" id="submit">
    <div id="typing"></div>
    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button>

    <div id="status">
    </div>


  <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="web/ocf.js" type="text/javascript"></script>
  <script src="plugins/typingIndicator.js" type="text/javascript"></script>
  <script type="text/javascript">

    var OCF = new OCFBuilder({
        globalConfigs: 'here'
    }, [
        new typingIndicator()
    ]);

    window.fbAsyncInit = function() {

    FB.init({
      appId      : '214943955383451',
      xfbml      : true,
      version    : 'v2.8'
    });

    function checkLoginState() {
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    }

    // This is called with the results from from FB.getLoginStatus().
     function statusChangeCallback(response) {

       if (response.status === 'connected') {
         // Logged into your app and Facebook.

         FB.api('/me', function(response) {

            let me = new OCF.User(response.id, response);

            let john = new OCF.User('john', {value: true});
            let mary = new OCF.User('mary', {value: true});

            var chat = me.createChat([john, mary]);

            chat.emitter.on('message', (payload) => {

                console.log(payload)

                $('#chat').append($('<div><strong>'+payload.sender.data.name+':</strong> ' + payload.data.text + '</div>'));

            });

            $('#message').on('change keyup paste click blur', () => {
                chat.typing.startTyping();
            });

            $('#submit').click(() => {
                
                chat.typing.stopTyping();

                chat.publish('message', {
                    text: $('#message').val()
                });

                $('#message').val('');

            });

            chat.emitter.on('startTyping', (payload) => {
                $('#typing').text('Typing...');
            });

            chat.emitter.on('stopTyping', (payload) => {
                $('#typing').text('');
            });

            chat.emitter.on('ready', () => {

            });

           console.log('Successful login for: ' + response.name);
           document.getElementById('status').innerHTML =
             'Thanks for logging in, ' + response.name + '!';
        
        });

       } else if (response.status === 'not_authorized') {
         // The person is logged into Facebook, but not your app.
         document.getElementById('status').innerHTML = 'Please log ' +
           'into this app.';
       } else {
         // The person is not logged into Facebook, so we're not sure if
         // they are logged into this app or not.
         document.getElementById('status').innerHTML = 'Please log ' +
           'into Facebook.';
       }
     }

     // This function is called when someone finishes with the Login
     // Button.  See the onlogin handler attached to it in the sample
     // code below.
     function checkLoginState() {
       FB.getLoginStatus(function(response) {
         statusChangeCallback(response);
       });
     }

     FB.getLoginStatus(function(response) {
       statusChangeCallback(response);
     });


      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "https://connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
        

  </script>
</body>
</html>
