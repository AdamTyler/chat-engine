<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Open Chat Framework Dev</title>

</head>

<body>

    <div id="chat">
    </div>
    <input type="text" id="message">
    <input type="submit" id="submit">
    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button>

    <div id="status">
    </div>


    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    
    <script src="../../web/ocf.js" type="text/javascript"></script>
    
    <script type="text/javascript">
        
        const OCF = OpenChatFramework.create({
            rltm: {
                service: 'pubnub', 
                config: {
                    publishKey: 'pub-c-4d01656a-cdd2-4474-adc3-30692132915c',
                    subscribeKey: 'sub-c-a59afd1c-a85b-11e6-af18-02ee2ddab7fe',
                }
            },
            globalChannel: 'ocf-facebook-demo'
        });

        window.fbAsyncInit = function() {

            FB.init({
                appId: '214943955383451',
                xfbml: true,
                version: 'v2.8'
            });

            function checkLoginState() {
                FB.getLoginStatus(function(response) {
                    statusChangeCallback(response);
                });
            }

            // This is called with the results from from FB.getLoginStatus().
            function statusChangeCallback(response) {

                if (response.status === 'connected') {
                    // Logged into your app and Facebook.

                    FB.api('/me', function(response) {

                        var me = OCF.connect(response.id, response);

                        var chat = new OCF.Chat('facebookchat');

                        FB.api(
                            "/" + response.id + "/picture",
                            function(response) {
                                if (response && !response.error) {

                                    console.log(me)
                                    me.data.state.avatar = response.data.url
                                }
                            }
                        );

                        chat.emitter.on('message', (payload) => {

                            console.log(payload.sender)

                            $('#chat').append($('<div><img src="' + payload.sender.data.state.avatar + '" style="border-radius: 50%; width: 20px; height: 20px; display: inline-block;"/><strong>' + payload.sender.data.state.name + ':</strong> ' + payload.data.text + '</div>'));

                        });

                        console.log('Successful login for: ' + response.name);
                        document.getElementById('status').innerHTML =
                            'Thanks for logging in, ' + response.name + '!';

                    });

                } else if (response.status === 'not_authorized') {
                    document.getElementById('status').innerHTML = 'Please log ' +
                        'into this app.';
                } else {
                    document.getElementById('status').innerHTML = 'Please log ' +
                        'into Facebook.';
                }
            }

            function checkLoginState() {
                FB.getLoginStatus(function(response) {
                    statusChangeCallback(response);
                });
            }

            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });


        };

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</body>

</html>
